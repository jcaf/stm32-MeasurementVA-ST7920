/*
 * ina229.h
 *
 *  Created on: Apr 3, 2023
 *      Author: jcaf
 */

#ifndef APPLICATION_USER_CORE_INA229_INA229_H_
#define APPLICATION_USER_CORE_INA229_INA229_H_

#define INA229_SPI_READ 1
#define INA229_SPI_WRITE 0

//INA229 Registers
#define INA229_REG_CONFIG		0x00	//16
#define INA229_REG_ADC_CONFIG	0x01	//16
#define INA229_REG_SHUNT_CAL	0x02	//16
#define INA229_REG_SHUNT_TEMPCO	0x03	//16
#define INA229_REG_VSHUNT		0x04	//24
#define INA229_REG_VBUS			0x05	//24
#define INA229_REG_DIETEMP		0x06	//16
#define INA229_REG_CURRENT		0x07	//24
#define INA229_REG_POWER		0x08	//24
#define INA229_REG_ENERGY		0x09	//40
#define INA229_REG_CHARGE		0x0A	//40
#define INA229_REG_DIAG_ALRT	0x0B	//16
#define INA229_REG_SOVL			0x0C	//16
#define INA229_REG_SUVL			0x0D	//16
#define INA229_REG_BOVL			0x0E	//16
#define INA229_REG_BUVL			0x0F	//16
#define INA229_REG_TEMP_LIMIT	0x10	//16
#define INA229_REG_PWR_LIMIT	0x11	//16
#define INA229_REG_MANUFACTURER_ID	0x3E//16
#define INA229_REG_DEVICE_ID		0x3F//16


//
#define IN229_CONFIG_ADCRANGE_163p84mV 0
#define IN229_CONFIG_ADCRANGE_40p96mV 1


//CONFIG REGISTER BITS
//Configuration (CONFIG) Register (Address = 0h) [reset = 0h]
#define INA229_CONFIG_BIT_RST 15
#define INA229_CONFIG_BIT_RSTACC 14
#define INA229_CONFIG_BIT_CONVDLY	6
#define INA229_CONFIG_BIT_TEMPCOMP	5
#define INA229_CONFIG_BIT_ADCRANGE	4

//ADC_CONFIG (Address = 1h) [reset = FB68h]
#define INA229_ADC_CONFIG_BIT_MODE 12
#define INA229_ADC_CONFIG_BIT_VBUSCT 9
#define INA229_ADC_CONFIG_BIT_VSHCT 6
#define INA229_ADC_CONFIG_BIT_VTCT 3
#define INA229_ADC_CONFIG_BIT_AVG 0

//ADC_CONFIG BITS
#define INA229_ADC_CONFIGMODE_SHUTDOWN0 0x00
#define INA229_ADC_CONFIGMODE_TRIGGEREDBUS_SINGLESHOT	0x01
#define INA229_ADC_CONFIGMODE_TRIGGEREDSHUNT_SINGLESHOT	0x02
#define INA229_ADC_CONFIGMODE_TRIGGEREDSHUNT_BUS_SINGLESHOT	0x03
#define INA229_ADC_CONFIGMODE_TRIGGEREDTEMPERATURE_SINGLESHOT 0x04
#define INA229_ADC_CONFIGMODE_TRIGGEREDTEMPERATURE_BUS_SINGLESHOT 0x05
#define INA229_ADC_CONFIGMODE_TRIGGEREDTEMPERATURE_SHUNT_SINGLESHOT 0x06
#define INA229_ADC_CONFIGMODE_TRIGGEREDBUS_SHUNT_TEMPERATURE_SINGLESHOT 0x07
#define INA229_ADC_CONFIGMODE_SHUTDOWN1 0x08
#define INA229_ADC_CONFIGMODE_CONTINUOUS_BUS_ONLY 0x09
#define INA229_ADC_CONFIGMODE_CONTINUOUS_SHUNT_ONLY 0x0A
#define INA229_ADC_CONFIGMODE_CONTINUOUS_SHUNT_BUS_ONLY 0x0B
#define INA229_ADC_CONFIGMODE_CONTINUOUS_TEMPERATURE_ONLY 0x0C
#define INA229_ADC_CONFIGMODE_CONTINUOUS_BUS_TEMPERATURE 0x0D
#define INA229_ADC_CONFIGMODE_CONTINUOUS_TEMPERATURE_SHUNT 0x0E
#define INA229_ADC_CONFIGMODE_CONTINUOUS_BUS_SHUNT_TEMPERATURE 0x0F

//ADC_CONFIG BITS CONVERSION TIME FOR VBUS = VSHUNT = VTEMPERATURE
#define INA229_ADC_CONFIGMODE_CT_50uS	0x00
#define INA229_ADC_CONFIGMODE_CT_84uS	0x01
#define INA229_ADC_CONFIGMODE_CT_150uS	0x02
#define INA229_ADC_CONFIGMODE_CT_280uS	0x03
#define INA229_ADC_CONFIGMODE_CT_540uS	0x04
#define INA229_ADC_CONFIGMODE_CT_1052uS	0x05
#define INA229_ADC_CONFIGMODE_CT_2074uS	0x06
#define INA229_ADC_CONFIGMODE_CT_4120uS	0x07

//ADC_CONFIG BITS AVG SAMPLE AVERAGING COUNT
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_1		0x00
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_4		0x01
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_16		0x02
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_64		0x03
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_128	0x04
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_256	0x05
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_512	0x06
#define INA229_ADC_CONFIGMODE_AVG_SAMPLE_1024	0x07




////////////////////////////////////////////////////////////////
//para mantener un CURRENT_LSB (redondeado) de 6e-6 el Maximum Expected Current deberia ser 3.1457Amp
//#define IN229_MAXIMUM_EXPECTED_CURRENT 3.1457//Amps 163.84e-3 / 50e-3

#define IN229_MAXIMUM_EXPECTED_CURRENT 0.8192//Amps 40.96e-3 /50e-3

#define INA229_CURRENT_LSB (IN229_MAXIMUM_EXPECTED_CURRENT/(1<<19))	//2^19 = 524288 =

#define INA229_RSHUNT 50.0E-3//50 miliOhms
//
#define INA229_SHUNT_CAL_ADCRANGE_163p84mV (13107.2E6 * INA229_CURRENT_LSB * INA229_RSHUNT)
//the value of SHUNT_CAL must be multiplied by 4 for ADCRANGE = 1
#define INA229_SHUNT_CAL_ADCRANGE_40p96mV INA229_SHUNT_CAL_ADCRANGE_163p84mV*4



void ina229_init(void);
int32_t INA229_read_current_register(void);

#endif /* APPLICATION_USER_CORE_INA229_INA229_H_ */
